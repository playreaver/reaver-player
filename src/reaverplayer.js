class ReaverPlayer {
    constructor(root) {
        this.root = root;
        const src = root.dataset.src;

        this.video = document.createElement('video');
        this.video.src = src;
        this.video.preload = 'metadata';
        this.video.style.display = 'block';
        root.appendChild(this.video);

        this.createControls();

        root.player = this;
        this.bindEvents();
    }

    createControls() {
        const controls = document.createElement('div');
        controls.className = 'controls';

        // Play/Pause
        this.playBtn = document.createElement('button');
        this.playBtn.className = 'btn';
        this.playBtn.innerHTML = '‚ñ∂';
        this.playBtn.title = 'Play/Pause';
        controls.appendChild(this.playBtn);

        // –í—Ä–µ–º—è
        this.time = document.createElement('span');
        this.time.className = 'time';
        this.time.textContent = '0:00 / 0:00';
        controls.appendChild(this.time);

        // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
        this.progressContainer = document.createElement('div');
        this.progressContainer.className = 'progress-container';
        
        this.buffer = document.createElement('div');
        this.buffer.className = 'buffer';
        
        this.progress = document.createElement('div');
        this.progress.className = 'progress';
        
        this.progressContainer.appendChild(this.buffer);
        this.progressContainer.appendChild(this.progress);
        controls.appendChild(this.progressContainer);

        // –ì—Ä–æ–º–∫–æ—Å—Ç—å
        this.volumeContainer = document.createElement('div');
        this.volumeContainer.className = 'volume-container';
        
        this.volumeBtn = document.createElement('button');
        this.volumeBtn.className = 'btn';
        this.volumeBtn.innerHTML = 'üîä';
        this.volumeBtn.title = 'Volume';
        
        this.volumeSlider = document.createElement('input');
        this.volumeSlider.type = 'range';
        this.volumeSlider.className = 'volume-slider';
        this.volumeSlider.min = 0;
        this.volumeSlider.max = 1;
        this.volumeSlider.step = 0.1;
        this.volumeSlider.value = 1;
        
        this.volumeContainer.appendChild(this.volumeBtn);
        this.volumeContainer.appendChild(this.volumeSlider);
        controls.appendChild(this.volumeContainer);

        // –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
        this.fullscreenBtn = document.createElement('button');
        this.fullscreenBtn.className = 'btn fullscreen-btn';
        this.fullscreenBtn.innerHTML = '‚õ∂';
        this.fullscreenBtn.title = 'Fullscreen';
        controls.appendChild(this.fullscreenBtn);

        // Picture-in-Picture
        this.pipBtn = document.createElement('button');
        this.pipBtn.className = 'btn pip-btn';
        this.pipBtn.innerHTML = 'üìå';
        this.pipBtn.title = 'Picture in Picture';
        controls.appendChild(this.pipBtn);

        // –ú–µ–Ω—é
        this.menu = document.createElement('div');
        this.menu.className = 'menu';

        this.menuBtn = document.createElement('button');
        this.menuBtn.className = 'menu-btn';
        this.menuBtn.innerHTML = '‚öôÔ∏è';
        this.menuBtn.title = 'Settings';
        this.menu.appendChild(this.menuBtn);

        this.menuContent = document.createElement('div');
        this.menuContent.className = 'menu-content';

        // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–ª–µ–µ—Ä–∞
        const playerTitle = document.createElement('h3');
        playerTitle.textContent = 'Reaver Player';
        this.menuContent.appendChild(playerTitle);

        // –°–∫–æ—Ä–æ—Å—Ç—å
        this.speedSelect = document.createElement('select');
        ['0.5x','0.75x','1x','1.25x','1.5x','2x'].forEach(s=>{
            const opt = document.createElement('option');
            opt.value = parseFloat(s);
            opt.textContent = s;
            if (s === '1x') opt.selected = true;
            this.speedSelect.appendChild(opt);
        });
        this.menuContent.appendChild(this.speedSelect);

        // –°–∫–∞—á–∞—Ç—å
        this.downloadBtn = document.createElement('button');
        this.downloadBtn.textContent = '–°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ';
        this.menuContent.appendChild(this.downloadBtn);

        // –ö–∞—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ
        if(this.root.dataset.sources){
            this.qualitySelect = document.createElement('select');
            const sources = JSON.parse(this.root.dataset.sources);
            sources.forEach(s=>{
                const opt = document.createElement('option');
                opt.value = s.url;
                opt.textContent = s.label;
                this.qualitySelect.appendChild(opt);
            });
            this.menuContent.appendChild(this.qualitySelect);
        }

        // –°—É–±—Ç–∏—Ç—Ä—ã
        this.subBtn = document.createElement('button');
        this.subBtn.textContent = '–°—É–±—Ç–∏—Ç—Ä—ã';
        this.menuContent.appendChild(this.subBtn);

        this.menu.appendChild(this.menuContent);
        controls.appendChild(this.menu);

        // –ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–µ–µ—Ä–∞
        const titleElement = document.createElement('div');
        titleElement.className = 'player-title';
        titleElement.textContent = 'Reaver Player v2.0';
        this.root.appendChild(titleElement);

        this.root.appendChild(controls);
    }

    bindEvents() {
        this.playBtn.addEventListener('click', ()=>this.toggle());
        this.video.addEventListener('timeupdate', ()=>this.updateProgress());
        this.video.addEventListener('progress', ()=>this.updateBuffer());
        this.video.addEventListener('loadedmetadata', ()=>this.updateTime());
        this.video.addEventListener('volumechange', ()=>this.updateVolumeIcon());

        this.progressContainer.addEventListener('click', e=>{
            const rect = this.progressContainer.getBoundingClientRect();
            const pct = (e.clientX - rect.left)/rect.width;
            this.video.currentTime = pct * this.video.duration;
        });

        // –ì—Ä–æ–º–∫–æ—Å—Ç—å
        this.volumeSlider.addEventListener('input', ()=>{
            this.video.volume = this.volumeSlider.value;
            this.updateVolumeIcon();
        });

        this.volumeBtn.addEventListener('click', ()=>{
            this.video.volume = this.video.volume > 0 ? 0 : 1;
            this.volumeSlider.value = this.video.volume;
            this.updateVolumeIcon();
        });

        // –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
        this.fullscreenBtn.addEventListener('click', ()=>this.toggleFullscreen());

        // Picture-in-Picture
        this.pipBtn.addEventListener('click', ()=>this.togglePip());

        // –ú–µ–Ω—é –∫–Ω–æ–ø–∫–∞
        this.menuBtn.addEventListener('click', ()=>{
            this.menuContent.style.display = this.menuContent.style.display==='block' ? 'none' : 'block';
        });

        // –°–∫–æ—Ä–æ—Å—Ç—å
        this.speedSelect.addEventListener('change', ()=>{
            this.video.playbackRate = parseFloat(this.speedSelect.value);
        });

        // –°–∫–∞—á–∞—Ç—å
        this.downloadBtn.addEventListener('click', ()=>{
            const a = document.createElement('a');
            a.href = this.video.currentSrc;
            a.download = 'video.mp4';
            a.click();
        });

        // –ö–∞—á–µ—Å—Ç–≤–æ
        if(this.qualitySelect){
            this.qualitySelect.addEventListener('change', ()=>{
                const t = this.video.currentTime;
                this.video.src = this.qualitySelect.value;
                this.video.currentTime = t;
                this.video.play();
            });
        }

        // –°—É–±—Ç–∏—Ç—Ä—ã
        this.subBtn.addEventListener('click', ()=>{
            alert('–§—É–Ω–∫—Ü–∏—è —Å—É–±—Ç–∏—Ç—Ä–æ–≤ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!');
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', (e) => {
            if (!this.menu.contains(e.target)) {
                this.menuContent.style.display = 'none';
            }
        });
    }

    toggle(){
        if(this.video.paused){
            this.video.play();
            this.playBtn.innerHTML='‚è∏';
        } else{
            this.video.pause();
            this.playBtn.innerHTML='‚ñ∂';
        }
    }

    updateProgress(){
        const pct = (this.video.currentTime / this.video.duration)*100;
        this.progress.style.width = pct+'%';
        this.updateTime();
    }

    updateBuffer() {
        if (this.video.buffered.length > 0) {
            const bufferedEnd = this.video.buffered.end(this.video.buffered.length - 1);
            const duration = this.video.duration;
            if (duration > 0) {
                this.buffer.style.width = (bufferedEnd / duration) * 100 + '%';
            }
        }
    }

    updateTime(){
        const format = t=>{
            const m = Math.floor(t/60);
            const s = Math.floor(t%60).toString().padStart(2,'0');
            return `${m}:${s}`;
        };
        this.time.textContent = `${format(this.video.currentTime)} / ${format(this.video.duration)}`;
    }

    updateVolumeIcon() {
        this.volumeBtn.innerHTML = this.video.volume === 0 ? 'üîá' : 
                                 this.video.volume < 0.5 ? 'üîà' : 'üîä';
    }

    toggleFullscreen() {
        if (!document.fullscreenElement) {
            this.root.requestFullscreen().catch(err => {
                alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º: ${err.message}`);
            });
        } else {
            document.exitFullscreen();
        }
    }

    async togglePip() {
        try {
            if (this.video !== document.pictureInPictureElement) {
                await this.video.requestPictureInPicture();
            } else {
                await document.exitPictureInPicture();
            }
        } catch (error) {
            alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Picture-in-Picture!');
        }
    }

    play(){ this.video.play(); this.playBtn.innerHTML='‚è∏'; }
    pause(){ this.video.pause(); this.playBtn.innerHTML='‚ñ∂'; }
    setSource(url){ this.video.src=url; this.video.play(); this.playBtn.innerHTML='‚è∏'; }
}

(function(){
    function boot(){
        document.querySelectorAll('.reaver-player').forEach(el=>{
            if(!el.player) new ReaverPlayer(el);
        });
    }
    if(document.readyState==='loading'){
        document.addEventListener('DOMContentLoaded', boot);
    } else boot();
    window.ReaverPlayer = ReaverPlayer;
})();

